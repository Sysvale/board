---
- name: ensures the right permissions on files
  file:
    path: '{{ ansistrano_release_path.stdout }}/{{ item }}'
    state: directory
    owner: www-data
    group: '{{ admin_group }}'
    recurse: yes
  with_items:
    - bootstrap
    - storage
  become: yes

- name: creates laravel necessary storage directories
  file:
    path: '{{ ansistrano_release_path.stdout }}/{{ item }}'
    state: directory
    owner: www-data
    group: '{{ admin_group }}'
  with_items:
    - storage/app
    - storage/app/public
    - storage/framework
    - storage/framework/cache
    - storage/framework/cache/data
    - storage/framework/sessions
    - storage/framework/testing
    - storage/framework/views
    - storage/logs
  become: yes

- name: runs db:seed once
  shell:
    cmd: php artisan db:seed -q --force > storage/logs/php_artisan_db:seed-{{ ansible_date_time.epoch }}
    creates: storage/logs/php_artisan_db:seed-*
    chdir: '{{ ansistrano_release_path.stdout }}'
  become: yes
  become_user: www-data

- name: runs create:devlog once
  shell:
    cmd: php artisan create:devlog -q --force > storage/logs/php_artisan_create:devlog-{{ ansible_date_time.epoch }}
    creates: storage/logs/php_artisan_create:devlog-*
    chdir: '{{ ansistrano_release_path.stdout }}'
  become: yes
  become_user: www-data

- name: runs issues:put-gitlab-id once
  shell:
    cmd: php artisan issues:put-gitlab-id -q --force > storage/logs/php_artisan_issues:put-gitlab-id-{{ ansible_date_time.epoch }}
    creates: storage/logs/php_artisan_issues:put-gitlab-id-*
    chdir: '{{ ansistrano_release_path.stdout }}'
  become: yes
  become_user: www-data

- name: runs create:members once
  shell:
    cmd: php artisan create:members "João Paulo" "Uendel Couto" "Esron Dtamar" "Ítalo André" -q --force > storage/logs/php_artisan_create:members-{{ ansible_date_time.epoch }}
    creates: storage/logs/php_artisan_create:members-*
    chdir: '{{ ansistrano_release_path.stdout }}'
  become: yes
  become_user: www-data
